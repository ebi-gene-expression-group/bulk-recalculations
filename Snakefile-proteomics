import os.path

# set of rules for baseline proteomics and differential proteomics

## This wf looks for curated config files and protein expression matrices
## provided by PRIDE and performs intermediate steps of renaming files, aggregation of
## technical replicates, estimate median values, decoration, generation of condensed sdrf,
## deploying to staging and loading on wwwdev using webAPI. 

# baseline proteomics rules

is_old_proteomics_dataset = os.path.exists( f"{wildcards['accession']}.old_proteomics_dataset" )


rule check_pride_tsv_files:
    """
    First lets check if the .tsv.undecorated and .tsv.undecorated.aggregated are not empty of data
    These tsv files will normally contain a first column with the gene identifier
    and then the data either in the 2nd (undecorated flavours) or 3rd column
    (for the decorated flavours, where the 2nd column here is for the gene symbol)
    """
    log: "logs/{accession}-check_pride_tsv_files.log"
    params:
        is_old=is_old_proteomics_dataset
    input:
        "{accession}.tsv.undecorated",
        "{accession}.tsv.undecorated.aggregated",
        "{accession}.tsv"
    output:
        temp("logs/{accession}-check_pride_tsv_files.done")
    shell:
        """
        set -e # snakemake on the cluster doesn't stop on error when --keep-going is set
        exec &> "{log}"

        source {workflow.basedir}/bin/proteomics_functions.sh

        check_tsv_data_file_not_empty_of_data {wildcards.accession}.tsv.undecorated 2
        check_tsv_data_file_not_empty_of_data {wildcards.accession}.tsv.undecorated.aggregated 2
        check_tsv_data_file_not_empty_of_data {wildcards.accession}.tsv 3

        # We skip some steps for older proteomics datasets that break otherwise
        if [ {params.old} == "False" ]; then
            echo "Skipping: "
            echo "- rename_files"
            echo "- removeGeneNamesInDataMatrix.R"
            echo "- gxa_summarize_expression.pl"
            echo "- appendColnamesInDataMatrix.R"
            echo "...as the study is an old proteomics dataset and this sets would break that."
        else
            touch {wildcards.accession}.new.dataset
        fi
        touch {output}
        """


rule processing_steps_newer_datasets:
    """
    rename analysis methods, format matrix in tsv format, 
    aggregate technical replicates, append columns with .WithInSampleAbundance
    and pick median value of quartiles
    """
    conda: "envs/proteomics_processing.yaml"
    log: "logs/{accession}-processing_steps_newer_datasets.log"
    input:
        rules.check_pride_tsv_files.output,
        "{accession}.new.dataset"
    output:
        analysis_methods="{accession}-analysis-methods.tsv",
        backup_undecorated="{accession}-.tsv.undecorated.backup",
        done=temp("logs/{accession}-processing_steps_newer_datasets")
    shell:
        """
        set -e # snakemake on the cluster doesn't stop on error when --keep-going is set
        exec &> "{log}"

        # rename analysis methods
        echo "renaming {wildcards.accession}"
        rename_files {wildcards.accession}

        # remove quotes and gename and make matrix in tsv format.
        # remove genename column as we will decorate using recent Ensembl annotations.
        if [ -f "{wildcards.accession}.tsv.undecorated.backup" ]; then
            echo "Remove genes names and make the matrix to tsv for {wildcards.accession}"
            {workflow.basedir}/proteomics-import/bin/removeGeneNamesInDataMatrix.R {wildcards.accession}.tsv.undecorated.backup
            # modifies existing {wildcards.accession}.tsv.undecorated
        fi

        # aggregate technical replicates
        echo "summarise expression for {wildcards.accession}"
        perl {workflow.basedir}/bin \
            --aggregate-quartiles \
            --configuration {wildcards.accession}-configuration.xml \
            < {wildcards.accession}.tsv.undecorated \
            > {wildcards.accession}.tsv.undecorated.aggregated

        # append columns with .WithInSampleAbundance and pick median value of quartiles
        echo "median values pick up and appending columns with sample abundance.."
        {workflow.basedir}/proteomics-import/bin/appendColnamesInDataMatrix.R {wildcards.accession}.tsv.undecorated.aggregated

        touch {output.done}
        """





rule decorate_baseline_proteomics_experiment:
    """
    This step performs decoration by mapping Ensembl ids with gene names with latest
    annotations from Ensembl.
    """

rule final_check_tsv_data_file_not_empty_of_data:
    """
    Check that the dataset was not harmed in the process.
    """

# rule copy_experiment_from_analysis_to_atlas_exps:

# rule get_magetab_for_experiment:


# differential proteomics rules